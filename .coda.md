# CODA Repository Overview

> Auto-generated by CODA. Keep in sync with the codebase.

## Project Overview

CODA (Claude Orchestrated Development Agent) is a Rust-based CLI tool and server that orchestrates AI-driven feature development workflows. It guides developers through a structured analyze → plan → implement → review → PR pipeline by invoking Claude AI with phase-specific prompts. The CLI provides a Ratatui-based TUI for interactive use, while the server offers Slack integration and session management for team-based workflows.

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    coda-cli (app)                        │
│  Ratatui TUI · Clap CLI · Line Editor · App Driver      │
└───────────────────────┬─────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────┐
│                   coda-server (app)                      │
│  Slack Integration · Command Dispatch · Session Mgmt    │
└───────────────────────┬─────────────────────────────────┘
                        │
┌───────────────────────▼─────────────────────────────────┐
│                   coda-core (lib)                        │
│  Engine · Planner · Runner · Reviewer                   │
│  FeatureScanner · GitOps · GhOps (traits)               │
│  Project / Task / State Mgmt · Config · Profiles        │
└──────────┬────────────────────────┬─────────────────────┘
           │                        │
┌──────────▼───────────┐  ┌────────▼─────────────────────┐
│    coda-pm (lib)     │  │  claude-agent-sdk-rs          │
│  Prompt Manager      │  │  (vendored)                   │
│  MiniJinja templates │  │  Claude AI client, streaming  │
│  init / plan / run   │  │  hooks, MCP, plugin types     │
└──────────────────────┘  └──────────────────────────────┘
```

### Core Abstractions

- **`GitOps` trait** (`coda-core::git`): Abstracts all `git` CLI operations (worktree, branch, commit, diff, push). Default implementation shells out to `git`. Enables unit testing without a real repo.
- **`GhOps` trait** (`coda-core::gh`): Abstracts `gh` CLI operations (PR status, PR listing). Default implementation shells out to `gh`.
- **`FeatureScanner`** (`coda-core::scanner`): Reads `.trees/` to discover features and their `state.yml` files. Separated from Engine for single-responsibility.
- **`Engine`** holds `Arc<dyn GitOps>`, `Arc<dyn GhOps>`, and `FeatureScanner`, sharing them with sub-sessions (`PlanSession`, `Runner`).

## Directory Guide

| Path | Purpose |
|------|---------|
| `apps/coda-cli` | Main CLI binary — TUI, CLI parsing, line editor, app orchestration |
| `apps/coda-server` | Server binary — Slack integration, command dispatch, session management |
| `crates/coda-core` | Core library — engine, planner, runner, reviewer, scanner, git/gh traits, project/task/state management, config, profiles |
| `crates/coda-pm` | Prompt manager — loads and renders Jinja2 prompt templates |
| `crates/coda-pm/templates` | Jinja2 templates organized by workflow phase (`init/`, `plan/`, `run/`) |
| `vendors/claude-agent-sdk-rs` | Vendored Rust SDK for Claude Agent (client, streaming, hooks, MCP) |
| `specs/` | Feature specs and design documents (PRDs, design, impl-plans, reviews) |
| `docs/` | Project documentation and research notes |
| `deploy/` | Deployment configuration (systemd service file) |
| `.coda/` | CODA project configuration (`config.yml`) |
| `.trees/` | Git worktrees for parallel feature development (gitignored) |

## Tech Stack

**Languages**
- Rust 2024 edition (primary, pinned via `rust-toolchain.toml`)
- Jinja2 (prompt templates via MiniJinja)

**Frameworks & Runtimes**
- Tokio — async runtime (`rt-multi-thread`)
- Ratatui + Crossterm — TUI rendering
- Clap — CLI argument parsing
- MiniJinja — prompt template engine

**Key Dependencies**
- `thiserror` — library error types
- `anyhow` — application error handling
- `serde` / `serde_json` / `serde_yaml` — serialization
- `tracing` / `tracing-subscriber` — structured logging
- `claude-agent-sdk-rs` (vendored) — Claude AI client
- `unicode-width` — terminal text width calculation

**Build & Tooling**
- Cargo workspace (resolver v2)
- Make — automation targets
- `cargo-nextest` — test runner
- `cargo-release` — release automation
- `git-cliff` — changelog generation
- `cargo-deny` — license/dependency policy

## Development Workflow

```bash
# Build
cargo build

# Format (nightly)
cargo +nightly fmt

# Lint (strict)
cargo clippy -- -D warnings

# Test
cargo test
# or with nextest
cargo nextest run

# Check licenses & banned crates
cargo deny check

# Security audit
cargo audit

# Run the CLI
cargo run -p coda-cli -- <args>

# Run the server
cargo run -p coda-server -- <args>
```

Makefile targets wrap these commands — run `make help` to list available targets.

## Key Patterns

- **Actor model**: Subsystems own their state and communicate via Tokio channels. No `Mutex`/`RwLock` on shared state — use `DashMap` or `ArcSwap` instead.
- **Error handling**: `thiserror` for library crates, `anyhow` with `.context()` for the application binary. No `unwrap()`/`expect()` in production code.
- **Async traits**: Native `async fn in trait` by default; `async-trait` only when `dyn Trait` object safety is required (documented at module level).
- **Configuration**: YAML files via the `config` crate; runtime-tunable values in config files, compile-time constants in code.
- **Prompt management**: Each workflow phase (`init`, `plan`, `run`) has dedicated Jinja2 templates in `crates/coda-pm/templates/`. `coda-pm` renders them with `MiniJinja`.
- **Specs convention**: `specs/{feature-name}-{type}.md` — types include `prd`, `design`, `impl-plan`, `verification-plan`, `review`. Update `specs/index.md` for each new spec.
- **No `unsafe`**: Zero `unsafe` blocks; pure-Rust crates preferred over FFI bindings.
- **Serde conventions**: `#[serde(rename_all = "camelCase")]` for JSON; `skip_serializing_if = "Option::is_none"` to omit nulls.
