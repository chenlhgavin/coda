# CODA Repository Overview

> Auto-generated by CODA. Keep in sync with the codebase.

## Project Overview

CODA (Claude Orchestrated Development Agent) is an AI-driven development agent that automates the feature development lifecycle from planning through pull request creation. It provides both a CLI with a TUI interface for interactive planning and a Slack server for team-based workflows. The core value proposition is structured, traceable, and resumable AI-assisted development: users describe a feature, an AI agent plans and implements it across phased stages, self-reviews the code, runs verification checks, and opens a pull request -- all with crash recovery, cost tracking, and graceful cancellation.

## Architecture Overview

```
+-------------------------------+      +-------------------------------+
|         apps/coda-cli         |      |       apps/coda-server        |
|   (TUI: Ratatui + Crossterm)  |      |  (Slack Socket Mode server)   |
|   Clap CLI argument parsing   |      |  WebSocket + REST dispatch    |
+---------------+---------------+      +---------------+---------------+
                |                                      |
                |          tokio::sync::mpsc            |
                |   (RunEvent, InitEvent,               |
                |    PlanStreamUpdate)                  |
                v                                      v
+------------------------------------------------------------------+
|                        crates/coda-core                          |
|                                                                  |
|  Engine ─── Runner ─── PhaseExecutors (dev/review/verify/docs/pr)|
|    |          |              |                                    |
|    |     AgentSession   PhaseContext ── StateManager              |
|    |          |              |                                    |
|  PlanSession  |         AsyncGitOps / AsyncGhOps                 |
|    |          |              |                                    |
|    +── AgentSession    GitOps / GhOps (traits)                   |
|                                                                  |
|  Config | AgentProfile | Scanner | Parsers | Reviewer | Task     |
+----------------------------+---------+---------------------------+
                             |         |
                             v         v
              +----------------+   +-------------------+
              | crates/coda-pm |   | claude-agent-sdk  |
              |  (MiniJinja    |   | -rs (vendored)    |
              |   templates)   |   | subprocess SDK    |
              +----------------+   +-------------------+
```

**coda-core** is the domain layer. It owns the execution engine, planning session, phased runner with decomposed phase executors, shared agent session abstraction, state manager with transition enforcement, and external tool abstractions (GitOps/GhOps traits with async wrappers). Both application binaries are thin frontends that delegate all domain logic here.

**coda-pm** is a utility layer providing Jinja2-style prompt template loading and rendering via MiniJinja. Templates are organized by workflow stage (`init/`, `plan/`, `run/`, `commit/`).

**coda-cli** provides an interactive TUI (Ratatui + Crossterm) for planning sessions and run progress display. It consumes streaming events from coda-core via unbounded mpsc channels and manages graceful cancellation via `CancellationToken`.

**coda-server** provides a Slack interface via Socket Mode WebSocket. It routes slash commands through a dispatch layer to command handlers that delegate to coda-core. Uses DashMap for concurrent session and binding state.

## Interface Design

### AgentSession (`crates/coda-core/src/session.rs`)
Shared agent session abstraction wrapping `ClaudeClient` with idle timeout detection, exponential backoff reconnection, response accumulation, and API error detection. Both `PlanSession` and `Runner` delegate agent interactions here, eliminating duplicated streaming logic. Emits `SessionEvent` variants through an optional channel so callers map to their own domain-specific types. Supports graceful cancellation via `CancellationToken`.

### PhaseExecutor (`crates/coda-core/src/phases/mod.rs`)
Trait for phase-specific execution logic. Each phase type (dev, review, verify, docs, PR) implements this trait. The `Runner` creates the appropriate executor and calls `execute()` with a shared `PhaseContext`. Uses native `async fn` in traits (not `#[async_trait]`) since executors are dispatched via `match`, not stored as trait objects.

### StateManager (`crates/coda-core/src/state.rs`)
Centralizes all state mutations with transition-invariant enforcement and persistence. Enforces phase transitions (`Pending -> Running -> Completed/Failed`), feature status transitions, and derives `current_phase` from phase statuses rather than storing an independent counter. Provides `spent_budget()` for budget tracking across resumed sessions.

### AsyncGitOps / AsyncGhOps (`crates/coda-core/src/async_ops.rs`)
Async wrappers around `Arc<dyn GitOps>` / `Arc<dyn GhOps>` that delegate every operation through `tokio::task::spawn_blocking`, keeping the Tokio runtime responsive. Sync callers use the underlying traits directly via `.inner()`.

### GitOps (`crates/coda-core/src/git.rs`)
Abstracts all git CLI operations: worktree add/remove, commit, branch, diff, push. `DefaultGitOps` shells out to `git`. Trait-based for testability without a real repository.

### GhOps (`crates/coda-core/src/gh.rs`)
Abstracts GitHub CLI operations: PR view, PR list, PR URL lookup. `DefaultGhOps` shells out to `gh`. Defines `PrState` enum (`Open`, `Merged`, `Closed`, `Draft`) with type-safe matching replacing string comparisons.

### Engine (`crates/coda-core/src/engine.rs`)
Top-level orchestrator composing GitOps, GhOps, FeatureScanner, PlanSession, and Runner. Entry points: `init()`, `plan()`, `run()`, `clean()`. Init flow uses `AgentSession` for streaming. Supports `CancellationToken` for graceful shutdown.

### PlanSession (`crates/coda-core/src/planner.rs`)
Multi-turn interactive planning conversation. Delegates agent interactions to `AgentSession`. Manages connect/disconnect, streaming, approve, and finalize (writes specs + state + worktree). Uses the Planner profile (read-only tools).

### Runner (`crates/coda-core/src/runner.rs`)
Thin orchestrator that dispatches to `PhaseExecutor` implementations by phase kind. Manages session lifecycle, cancellation checking between phases, and `RunEvent` emission. Phase-specific logic is in the `phases/` submodules.

### AgentProfile (`crates/coda-core/src/profile.rs`)
Maps task types to `ClaudeAgentOptions`. Two profiles: Planner (read-only tools) and Coder (full tools + safety hooks).

### PromptManager (`crates/coda-pm/src/manager.rs`)
Template registry that loads `.j2` files from directories and built-in sources. Renders with MiniJinja contexts. Supports user overrides via `extra_dirs`.

## Data Flow

### Feature Development Pipeline (`coda run`)

```
state.yml ──> StateManager ──> Load & Resume ──> Runner::execute()
                                                      |
              ┌───────────────────────────────────────┘
              v
[DevPhaseExecutor 1] ──> ... ──> [DevPhaseExecutor N]
       |                                  |
    AgentSession::send()             AgentSession::send()
    commit + StateManager.save()     commit + StateManager.save()
                                          |
              ┌───────────────────────────┘
              v
[ReviewPhaseExecutor] ──> [VerifyPhaseExecutor] ──> [DocsPhaseExecutor]
       |                        |                         |
  self-review              cargo build,                update .coda.md
  + codex review           fmt, clippy, test           + README.md
       |                        |                         |
       v                        v                         v
                    [PrPhaseExecutor]
                         |
                    squash, push,
                    gh pr create
```

1. **Load state** -- `StateManager` reads `FeatureState` from `.coda/<feature>/state.yml`, derives `current_phase` from phase statuses for crash recovery
2. **Dev phases** -- `DevPhaseExecutor` renders prompt template, sends to Claude via `AgentSession::send()`, streams response with idle timeout + reconnection, commits changes, updates state via `StateManager`
3. **Review** -- `ReviewPhaseExecutor` runs Claude self-review and/or Codex independent review (engine: claude/codex/hybrid), filtering by `ReviewSeverity` (only Critical/Major are actionable)
4. **Verify** -- `VerifyPhaseExecutor` runs configured checks, agent fixes failures, retries up to `max_verify_retries` times (total attempts = 1 + retries)
5. **Update docs** -- `DocsPhaseExecutor` updates `.coda.md` and `README.md`
6. **Create PR** -- `PrPhaseExecutor` squashes commits (optional), pushes branch, creates PR via `gh` CLI, extracts PR title from agent response or gh CLI

Between each phase, the runner checks the `CancellationToken` and returns `CoreError::Cancelled` if triggered. Budget tracking uses `StateManager::spent_budget()` to compute remaining budget across resumed sessions.

### Interactive Planning (`coda plan`)

```
User ──> PlanSession ──> AgentSession::send() ──> streaming response
  ^                                                       |
  |              PlanStreamUpdate events via mpsc          |
  +───────────────────────────────────────────────────────+
                             |
                       User approves
                             |
                             v
              Generate spec + verification plan
              Create worktree, write state.yml
              Initial commit on feature branch
```

### Slack Dispatch (`coda-server`)

```
Slack ──> WebSocket envelope ──> dispatch()
              |
              +── slash_commands ──> command handler ──> Engine
              +── events_api ──> event handler
              +── interactive ──> interaction handler
              |
              v
         BindingStore (DashMap) resolves channel -> repo
         Progress streamed to Slack thread via SlackClient
```

## Core Data Structures

### FeatureState (`state.rs`)
Persistent state tracking feature execution. Fields: `feature` (FeatureInfo), `status` (FeatureStatus enum), `current_phase` (u32, derived by StateManager), `git` (GitInfo), `phases` (Vec<PhaseRecord>), `pr` (Option<PrInfo>), `total` (TotalStats). Serialized as YAML. `spent_budget()` sums cost across completed phases for budget tracking on resume.

### StateManager (`state.rs`)
Wraps `FeatureState` + `PathBuf` and centralizes mutations: `mark_phase_running()`, `complete_phase()`, `fail_phase()`, `set_feature_status()`, `set_pr()`, `save()`. Derives `current_phase` from phase statuses before each save. Enforces valid phase transitions and feature status transitions.

### PhaseOutcome (`state.rs`)
Complete metrics from a phase execution: cost, tokens, turns, duration, and optional commit SHA. Used by `StateManager::complete_phase()` to record results.

### SessionEvent (`session.rs`)
Streaming events emitted by `AgentSession::send()`: `TextDelta`, `ToolActivity`, `TurnCompleted`, `IdleWarning`, `Reconnecting`. Callers map these to domain-specific types (`RunEvent`, `PlanStreamUpdate`).

### AgentResponse (`session.rs`)
Accumulated response from a complete agent interaction: text content, tool result text, and metrics (turns, cost, tokens).

### SessionConfig (`session.rs`)
Configuration for `AgentSession`: `idle_timeout_secs`, `tool_execution_timeout_secs`, `idle_retries`, `max_budget_usd`.

### PhaseExecutor trait (`phases/mod.rs`)
Async trait for phase-specific logic. Implementations: `DevPhaseExecutor`, `ReviewPhaseExecutor`, `VerifyPhaseExecutor`, `DocsPhaseExecutor`, `PrPhaseExecutor`.

### PhaseContext (`phases/mod.rs`)
Shared mutable context passed to executors: `AgentSession`, `StateManager`, `PromptManager`, `CodaConfig`, `AsyncGitOps`, `AsyncGhOps`, progress channel, metrics tracker, and review/verification summaries.

### ReviewSeverity (`reviewer.rs`)
Enum: `Critical`, `Major`, `Minor`, `Info`. Only `Critical` and `Major` are actionable (trigger fix attempts). Case-insensitive `FromStr`, serde roundtrip support.

### PrState (`gh.rs`)
Enum: `Open`, `Merged`, `Closed`, `Draft`. Replaces string comparisons with pattern matching. `is_terminal()` returns true for `Merged`/`Closed`. Serde with UPPERCASE format for GitHub CLI compatibility.

### ReasoningEffort (`config.rs`)
Enum: `Low`, `Medium`, `High`. Used for Codex CLI reasoning effort. Accepts legacy aliases (`minimal` -> Low, `xhigh` -> High). Case-insensitive parsing.

### Task (`task.rs`)
Enum representing pipeline work units: `Init`, `Plan`, `DevPhase`, `Review`, `Verify`, `UpdateDocs`, `CreatePr`.

### CodaConfig (`config.rs`)
Project configuration loaded from `.coda/config.yml`. Covers agent settings, git conventions, review settings (engine, codex model, `ReasoningEffort`), and verify settings (`max_verify_retries` with `max_retries` alias for backward compatibility).

## Module Guide

| Path | Purpose |
|------|---------|
| `crates/coda-core/src/session.rs` | Shared agent session: streaming, timeout, reconnect, cancellation |
| `crates/coda-core/src/phases/mod.rs` | PhaseExecutor trait, PhaseContext, MetricsTracker, shared types |
| `crates/coda-core/src/phases/dev.rs` | Dev phase executor |
| `crates/coda-core/src/phases/review.rs` | Review phase executor (claude/codex/hybrid engines) |
| `crates/coda-core/src/phases/verify.rs` | Verify phase executor with bounded retry loop |
| `crates/coda-core/src/phases/docs.rs` | Update-docs phase executor |
| `crates/coda-core/src/phases/pr.rs` | PR creation phase executor with title extraction |
| `crates/coda-core/src/state.rs` | FeatureState, StateManager, PhaseOutcome, migration |
| `crates/coda-core/src/async_ops.rs` | AsyncGitOps/AsyncGhOps spawn_blocking wrappers |
| `crates/coda-core/src/engine.rs` | Top-level orchestrator: init, plan, run, clean |
| `crates/coda-core/src/runner.rs` | Thin phase dispatch orchestrator, RunEvent emission |
| `crates/coda-core/src/planner.rs` | Interactive planning session |
| `crates/coda-core/src/reviewer.rs` | ReviewSeverity enum, ReviewResult type |
| `crates/coda-core/src/gh.rs` | GhOps trait, PrState enum, DefaultGhOps |
| `crates/coda-core/src/git.rs` | GitOps trait, DefaultGitOps |
| `crates/coda-core/src/config.rs` | CodaConfig, ReasoningEffort enum, VerifyConfig |
| `crates/coda-core/src/error.rs` | CoreError enum (includes Cancelled, BudgetExhausted, IdleTimeout) |
| `crates/coda-core/src/profile.rs` | AgentProfile: Planner and Coder SDK option sets |
| `crates/coda-core/src/parser.rs` | Output parsers: PR URL/number/title, verification results |
| `crates/coda-core/src/codex.rs` | Codex CLI integration for independent code review |
| `crates/coda-core/src/scanner.rs` | FeatureScanner: discovers features from worktree directories |
| `crates/coda-core/src/task.rs` | Task and TaskResult types |
| `crates/coda-pm/` | Prompt Manager: template loading, rendering, built-in `.j2` templates |
| `crates/coda-pm/templates/` | Jinja2 prompt templates by stage: `init/`, `plan/`, `run/`, `commit/` |
| `apps/coda-cli/` | CLI application: TUI (Ratatui), interactive planning, run progress display |
| `apps/coda-server/` | Slack server: Socket Mode WebSocket, slash command dispatch, session management |
| `vendors/claude-agent-sdk-rs/` | Vendored Claude Agent SDK (git submodule) |
| `deploy/` | Deployment config: systemd service unit for coda-server |
| `.coda/` | Project-level CODA config and feature state directories |
| `.trees/` | Git worktrees for feature branches |

## Tech Stack & Dependencies

| Category | Technology | Role |
|----------|-----------|------|
| Language | Rust (Edition 2024) | Primary language |
| Async runtime | Tokio 1.43 | Multi-threaded async runtime |
| Cancellation | tokio-util 0.7 | `CancellationToken` for graceful shutdown |
| TUI | Ratatui 0.30 + Crossterm 0.29 | Terminal UI for CLI |
| CLI parsing | Clap 4.5 | Argument parsing with derive macros |
| Templates | MiniJinja 2.6 | Jinja2-style prompt rendering |
| WebSocket | Tokio-Tungstenite 0.24 | Slack Socket Mode connection |
| HTTP | Reqwest 0.12 (rustls-tls) | Slack Web API client |
| Serialization | Serde + serde_yaml + serde_json | YAML/JSON (de)serialization |
| Error handling | thiserror 2.0 / anyhow 1.0 | Library error enums / app error propagation |
| Logging | tracing 0.1 + tracing-subscriber 0.3 | Structured logging with env-filter |
| Concurrency | DashMap 6.1 | Lock-free concurrent HashMap |
| AI SDK | claude-agent-sdk-rs 0.6 | Claude subprocess communication |
| Streaming | futures 0.3 | Stream combinators for agent response processing |
| Testing | cargo-nextest | Parallel test runner |
| Linting | cargo-deny, typos | Dependency policy, spell checking |
| Changelog | git-cliff | Conventional commit changelog generation |

## Development Workflow

```bash
# Build
cargo build                              # Debug build
cargo build --release --bin coda-server   # Release build (server)

# Test
cargo nextest run --all-features         # Run all tests
cargo test -- --ignored                  # Run slow/ignored tests

# Format & Lint
cargo +nightly fmt                       # Format code
cargo +nightly fmt -- --check            # Check formatting
cargo clippy -- -D warnings              # Lint with warnings as errors

# Other
cargo audit                              # Security vulnerability check
cargo doc --open                         # Generate and view docs
make deploy                              # Build release + install systemd + restart
```

## Key Patterns & Conventions

**Decomposed phase executors**: Runner dispatches to `PhaseExecutor` implementations by phase kind. Each executor (dev, review, verify, docs, PR) is a focused, independently testable component that receives a shared `PhaseContext`.

**Shared agent session**: `AgentSession` encapsulates the streaming/timeout/reconnect pattern used by both `PlanSession` and `Runner`, eliminating duplicated logic. Emits generic `SessionEvent` variants that callers map to domain-specific event types.

**State manager with invariants**: `StateManager` centralizes all state mutations, enforcing valid phase transitions and deriving `current_phase` from phase statuses rather than an independent counter. Budget tracking via `spent_budget()` sums completed phase costs for correct remaining budget on resume.

**Async-safe blocking wrappers**: `AsyncGitOps` and `AsyncGhOps` wrap blocking CLI operations in `spawn_blocking`, keeping the Tokio runtime responsive. Sync callers continue using the underlying traits directly.

**Type-safe enums**: `ReviewSeverity`, `PrState`, and `ReasoningEffort` replace stringly-typed fields with pattern-matchable enums. All have `FromStr` (case-insensitive), `Display`, and serde roundtrip support. Backward-compatible deserialization via aliases.

**Graceful cancellation**: `CancellationToken` threads through Engine -> Runner -> AgentSession. Checked between phases and races against streaming. Returns `CoreError::Cancelled` with state already persisted for seamless resume.

**Actor-like concurrency**: Subsystems (PlanSession, Runner) own their state and communicate via `tokio::sync::mpsc` channels. Streaming events (`RunEvent`, `PlanStreamUpdate`, `InitEvent`) flow from core to UI/server layers.

**Trait-based abstraction**: External tool interactions (git, gh) are behind traits (`GitOps`, `GhOps`) with default implementations that shell out to CLI tools. This enables unit testing without real repositories.

**Error handling**: Library crates use `thiserror` enums (`CoreError`, `PromptError`) with `#[non_exhaustive]`. Apps use `anyhow::Result` with `.context()`. No `unwrap()`/`expect()` in production code.

**Template-driven prompts**: All agent prompts are MiniJinja `.j2` templates organized by workflow stage. User overrides via `extra_dirs` allow customization without modifying built-in templates.

**Configuration**: YAML-based via `.coda/config.yml`. Runtime-tunable values in config; compile-time constants for fixed values. Backward-compatible field renames via `#[serde(alias)]`.
