# CODA Repository Overview

> Auto-generated by CODA. Serves as a quick-reference guide for AI agents.

## Project Overview

CODA (Claude Orchestrated Development Agent) is a CLI tool that orchestrates structured, traceable feature development using Claude AI. It implements a Plan → Execute → Review → Verify → PR pipeline, where each phase is driven by Jinja2 prompt templates rendered and sent to the Claude Agent SDK. The project provides a Ratatui-based TUI for interactive use and a standard CLI interface for automation.

## Architecture

```
┌─────────────────────────────────────────────────────┐
│                  apps/coda-cli                      │
│         Ratatui TUI  +  Clap CLI frontend           │
└───────────────────┬─────────────────────────────────┘
                    │
┌───────────────────▼─────────────────────────────────┐
│                crates/coda-core                     │
│  Engine · Planner · Runner · Reviewer · State FSM   │
│        Task Management · Project Management         │
└──────────┬──────────────────────────┬───────────────┘
           │                          │
┌──────────▼──────────┐   ┌──────────▼──────────────┐
│   crates/coda-pm    │   │  vendors/claude-agent-  │
│  Prompt Manager     │   │       sdk-rs            │
│  Jinja2 Templates   │   │  Claude Agent API SDK   │
└─────────────────────┘   └─────────────────────────┘
```

**Pipeline phases:** `init → plan → execute → review → verify → pr`

Each phase loads a phase-specific Jinja2 template from `crates/coda-pm/templates/`, renders it with context, and sends it to the Claude Agent SDK. The state machine in `coda-core` drives transitions between phases.

## Directory Guide

| Directory | Purpose |
|-----------|---------|
| `apps/coda-cli/` | Main CLI binary — TUI (`app.rs`, `ui.rs`), CLI parsing (`cli.rs`), line editor (`line_editor.rs`) |
| `crates/coda-core/` | Core library — engine, planner, runner, reviewer, state machine, task/project management |
| `crates/coda-pm/` | Prompt manager — loads and renders Jinja2 prompt templates per workflow phase |
| `crates/coda-pm/templates/` | Jinja2 templates organized by phase: `init/`, `plan/`, `run/` |
| `vendors/claude-agent-sdk-rs/` | Vendored Rust SDK for Claude Agent API (client, transport, types) |
| `specs/` | Design specs and PRD documents (naming: `{feature}-{type}.md`) |
| `docs/` | Project documentation and research notes |
| `.coda/` | CODA configuration and feature tracking state |
| `.trees/` | Git worktrees for parallel feature development (gitignored) |

## Tech Stack

**Language:** Rust (2024 edition), pinned in `rust-toolchain.toml`

**Frameworks & Runtimes:**
- `ratatui` + `crossterm` — terminal UI
- `tokio` — async runtime (multi-thread, full features)
- `clap` — CLI argument parsing
- `minijinja` — Jinja2-style prompt template engine

**Error Handling:** `thiserror` (library crates) + `anyhow` (application crate)

**Observability:** `tracing` + `tracing-subscriber`

**Serialization:** `serde` + `serde_json` / `serde_yaml`

**Build & Tooling:**
- `cargo-nextest` — test runner
- `cargo-release` — release management
- `git-cliff` — changelog generation
- `cargo-deny` — license/dependency policy enforcement

## Development Workflow

```bash
# Build
cargo build

# Run tests
cargo nextest run
# or
cargo test

# Format (nightly)
cargo +nightly fmt

# Lint (strict)
cargo clippy -- -D warnings

# Check licenses and banned crates
cargo deny check

# Run the CLI
cargo run -p coda-cli -- <command>

# Run the TUI
cargo run -p coda-cli
```

## Key Patterns

- **Actor model:** each subsystem owns its state and communicates via `tokio::sync::mpsc` channels; no `Mutex<T>` on shared state.
- **Error propagation:** always use `?` with `.context()`/`.with_context()`; never `unwrap()`/`expect()` in production code.
- **Async traits with `dyn`:** use `async-trait` crate only when trait requires object safety (`Arc<dyn Trait>`); document the reason.
- **Configuration:** YAML files via `config` crate; `ArcSwap` for runtime-reloadable config.
- **Prompt templates:** each pipeline phase has a dedicated Jinja2 template under `crates/coda-pm/templates/<phase>/`. Add new phases by adding a template directory and registering in `coda-pm`.
- **State machine:** phase transitions are encoded as enum variants in `coda-core`; illegal transitions are unrepresentable at the type level.
- **Specs:** placed in `specs/{feature-name}-{type}.md`; `specs/index.md` is kept up to date.
- **Docs:** placed in `docs/`; `docs/index.md` is kept up to date.
- **Workspace deps:** all shared dependencies declared in root `Cargo.toml` `[workspace.dependencies]` and referenced with `{ workspace = true }`.
