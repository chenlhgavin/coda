You are {% if force %}reinitializing{% else %}initializing{% endif %} a repository for use with CODA (Claude Orchestrated Development Agent).

## Repository

- **Root**: `{{ project_root }}`
{% if force %}- **Mode**: Reinitialize (update config and regenerate docs, preserve user settings){% endif %}

## Analysis Results

{{ analysis_result }}

## Task

Perform the following steps in order:
{% if force %}
### 1. Update `.coda/config.yml`

Read the existing config at `{{ project_root }}/.coda/config.yml`. **Preserve all user-customized settings** (such as `agent.max_budget_usd`, `agent.model`, `review.engine`, `review.codex_model`, `review.codex_reasoning_effort`, `git.branch_prefix`, etc.). Only update the `checks` list to match the current tech stack detected in the analysis above. If any new config fields are missing from the existing file, add them with sensible defaults.

### 2. Regenerate `.coda.md`

Delete the existing `{{ project_root }}/.coda.md` and generate a fresh repository overview document. This file serves as a quick-reference guide for AI agents. Include:

1. **Project Overview** — One paragraph describing what this project does
2. **Architecture** — Brief description with ASCII diagram if applicable
3. **Directory Guide** — Table of important directories and their purposes
4. **Tech Stack** — Languages, frameworks, key dependencies
5. **Development Workflow** — How to build, test, and run the project
6. **Key Patterns** — Important conventions used in this codebase

Base the content on the analysis results above. Keep under 200 lines.

### 3. Update `.gitignore`

Append the following to `{{ project_root }}/.gitignore` (create the file if it doesn't exist). Only add lines that are not already present:

```
# CODA worktrees
.trees/
```

### 4. Update `CLAUDE.md`

If `{{ project_root }}/CLAUDE.md` exists, ensure it contains the following reference (skip if already present):

```markdown

## CODA Repository Documentation

See [.coda.md](.coda.md) for a comprehensive overview of this repository's structure, tech stack, and conventions. This file is auto-generated by CODA and kept up to date.
```

If `CLAUDE.md` does not exist, create it with just the above content.
{% else %}
### 1. Create `.coda/` directory

```bash
mkdir -p "{{ project_root }}/.coda"
```

### 2. Create `.trees/` directory

```bash
mkdir -p "{{ project_root }}/.trees"
```

### 3. Generate `.coda/config.yml`

Create the file `{{ project_root }}/.coda/config.yml`. Based on the detected tech stack in the analysis results above, determine the appropriate build/lint/format checks for this project and fill them in.

```yaml
# CODA Project Configuration
version: 1

agent:
  model: "claude-opus-4-6"
  permission_mode: "auto"
  max_retries: 3

git:
  auto_commit: true
  branch_prefix: "feature"
  commit_prefix: "feat"

review:
  enabled: true
  engine: codex
  checks:
    # Determine appropriate checks from the detected tech stack.
    # Examples:
    #   Rust: cargo build, cargo +nightly fmt -- --check, cargo clippy -- -D warnings
    #   Node: npm run build, npm run lint, npm test
    #   Python: ruff check, mypy, pytest
    - "<fill based on tech stack>"
  max_review_rounds: 5
```

### 4. Update `.gitignore`

Append the following to `{{ project_root }}/.gitignore` (create the file if it doesn't exist). Only add lines that are not already present:

```
# CODA worktrees
.trees/
```

### 5. Generate `.coda.md`

Generate a concise repository overview document at `{{ project_root }}/.coda.md`. This file serves as a quick-reference guide for AI agents. Include:

1. **Project Overview** — One paragraph describing what this project does
2. **Architecture** — Brief description with ASCII diagram if applicable
3. **Directory Guide** — Table of important directories and their purposes
4. **Tech Stack** — Languages, frameworks, key dependencies
5. **Development Workflow** — How to build, test, and run the project
6. **Key Patterns** — Important conventions used in this codebase

Base the content on the analysis results above. Keep under 200 lines.

### 6. Update `CLAUDE.md`

If `{{ project_root }}/CLAUDE.md` exists, append the following reference at the end (skip if already present):

```markdown

## CODA Repository Documentation

See [.coda.md](.coda.md) for a comprehensive overview of this repository's structure, tech stack, and conventions. This file is auto-generated by CODA and kept up to date.
```

If `CLAUDE.md` does not exist, create it with just the above content.
{% endif %}

## Verification

After completing all steps, verify:
{% if force %}- [ ] `.coda/config.yml` is valid YAML with user settings preserved and checks updated
- [ ] `.coda.md` exists and is well-formatted
- [ ] `.gitignore` contains `.trees/`
- [ ] `CLAUDE.md` references `.coda.md`
{% else %}- [ ] `.coda/` directory exists
- [ ] `.trees/` directory exists
- [ ] `.coda/config.yml` is valid YAML with appropriate checks
- [ ] `.gitignore` contains `.trees/`
- [ ] `.coda.md` exists and is well-formatted
- [ ] `CLAUDE.md` references `.coda.md`
{% endif %}
Report the result of each verification step.
