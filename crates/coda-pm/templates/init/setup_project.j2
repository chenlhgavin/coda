You are {% if force %}reinitializing{% else %}initializing{% endif %} a repository for use with CODA (Claude Orchestrated Development Agent).

## Repository

- **Root**: `{{ project_root }}`
{% if force %}- **Mode**: Reinitialize (update config and regenerate docs, preserve user settings){% endif %}

## Analysis Results

{{ analysis_result }}

## Task

Perform the following steps in order:
{% if force %}
### 1. Update `.coda/config.yml`

Read the existing config at `{{ project_root }}/.coda/config.yml`. **Preserve all user-customized settings** (such as `agent.max_budget_usd`, `agent.model`, `agents.*`, `review.codex_reasoning_effort`, `git.branch_prefix`, etc.). Set `review.engine` to `codex` (the current default). If any new config fields are missing from the existing file, add them with sensible defaults. **Important**: `review.codex_model` must be an OpenAI-compatible model (e.g., `gpt-5.3-codex`). If it is currently set to a Claude model (e.g., `claude-opus-4-6`), correct it to `gpt-5.3-codex`. Ensure the `agents` section exists with per-operation overrides for `init`, `plan`, `run`, and `review` (each may specify `backend`, `model`, and `effort`).

### 2. Regenerate `.coda.md`

Delete the existing `{{ project_root }}/.coda.md` and generate a fresh **architecture reference** — a descriptive map for AI agents and developers to quickly understand the codebase. Structure it as follows:

1. **Project Overview** — One paragraph: what the project does, the problem it solves, and its core value proposition
2. **Architecture Overview** — ASCII box diagram showing module/crate/package relationships and layer boundaries. Below the diagram, briefly describe each module's responsibility and how they depend on each other
3. **Module Guide** — Table mapping directory paths to their purposes
4. **Key Interfaces** — List the key traits, interfaces, or abstract types that define module boundaries. For each, state: name, module path, what it abstracts, and why it exists
5. **Data Flow** — Describe the primary data processing pipelines. Use ASCII flow diagrams where helpful. For each flow, list the stages and what data transformations occur
6. **Core Data Structures** — Document the key types, enums, and structs that form the domain model. Describe their relationships, state machines (if any), and serialization conventions

Do NOT include development workflow commands, coding conventions, or tech stack listings — those belong in CLAUDE.md.

Start with: `# CODA Repository Overview` and `> Auto-generated by CODA. Keep in sync with the codebase.`

Base the content on the analysis results above. Keep under 300 lines.

### 3. Update `.gitignore`

Append the following to `{{ project_root }}/.gitignore` (create the file if it doesn't exist). Only add lines that are not already present:

```
# CODA worktrees
.trees/
```

### 4. Generate or Update `CLAUDE.md`

This file provides project-specific working instructions for AI agents and developers. Focus on decisions and conventions that are **unique to this project** — do NOT include generic language best practices that an AI agent already knows.

{% raw %}**If `CLAUDE.md` already exists:**{% endraw %}

1. Read the existing content carefully
2. Preserve all user-customized rules and project-specific guidelines
3. Ensure the following sections exist (add missing ones, do not duplicate existing ones):
   - **Toolchain & Workflow** — Exact build, test, lint, and format commands for this project
   - **Project Conventions** — Project-specific technical decisions that cannot be inferred from code alone. Each rule must be concrete and actionable. Bad: "Use iterators instead of explicit loops". Good: "Library crates use thiserror; application crates use anyhow with .context()"
   - **Architecture Decisions** — Key architectural choices and their rationale (e.g., why Actor model, why specific crate choices)
4. Ensure the file ends with the CODA reference section (add if missing):

```markdown

## CODA Repository Documentation

See [.coda.md](.coda.md) for architecture overview and module guide. This file is auto-generated by CODA and kept up to date.
```

{% raw %}**If `CLAUDE.md` does not exist:**{% endraw %}

Generate a `CLAUDE.md` with the sections listed above, tailored to the detected tech stack. Target **60-80 lines**. Focus on project-SPECIFIC decisions that an AI agent cannot infer from the code itself. If a rule is standard practice for the detected language, do NOT include it.

The file must end with the CODA reference section shown above.
{% else %}
### 1. Create `.coda/` directory

```bash
mkdir -p "{{ project_root }}/.coda"
```

### 2. Create `.trees/` directory

```bash
mkdir -p "{{ project_root }}/.trees"
```

### 3. Generate `.coda/config.yml`

Create the file `{{ project_root }}/.coda/config.yml`.

```yaml
# CODA Project Configuration
version: 1

agents:
  run:
    backend: claude
    model: "claude-sonnet-4-6"
  review:
    backend: codex
    model: "gpt-5.3-codex"
    effort: "high"
```

### 4. Update `.gitignore`

Append the following to `{{ project_root }}/.gitignore` (create the file if it doesn't exist). Only add lines that are not already present:

```
# CODA worktrees
.trees/
```

### 5. Generate `.coda.md`

Generate an **architecture reference** at `{{ project_root }}/.coda.md` — a descriptive map for AI agents and developers to quickly understand the codebase. Structure it as follows:

1. **Project Overview** — One paragraph: what the project does, the problem it solves, and its core value proposition
2. **Architecture Overview** — ASCII box diagram showing module/crate/package relationships and layer boundaries. Below the diagram, briefly describe each module's responsibility and how they depend on each other
3. **Module Guide** — Table mapping directory paths to their purposes
4. **Key Interfaces** — List the key traits, interfaces, or abstract types that define module boundaries. For each, state: name, module path, what it abstracts, and why it exists
5. **Data Flow** — Describe the primary data processing pipelines. Use ASCII flow diagrams where helpful. For each flow, list the stages and what data transformations occur
6. **Core Data Structures** — Document the key types, enums, and structs that form the domain model. Describe their relationships, state machines (if any), and serialization conventions

Do NOT include development workflow commands, coding conventions, or tech stack listings — those belong in CLAUDE.md.

Start with: `# CODA Repository Overview` and `> Auto-generated by CODA. Keep in sync with the codebase.`

Base the content on the analysis results above. Keep under 300 lines.

### 6. Generate or Update `CLAUDE.md`

This file provides project-specific working instructions for AI agents and developers. Focus on decisions and conventions that are **unique to this project** — do NOT include generic language best practices that an AI agent already knows.

{% raw %}**If `CLAUDE.md` already exists:**{% endraw %}

1. Read the existing content carefully
2. Preserve all user-customized rules and project-specific guidelines
3. Ensure the following sections exist (add missing ones, do not duplicate existing ones):
   - **Toolchain & Workflow** — Exact build, test, lint, and format commands for this project
   - **Project Conventions** — Project-specific technical decisions that cannot be inferred from code alone. Each rule must be concrete and actionable. Bad: "Use iterators instead of explicit loops". Good: "Library crates use thiserror; application crates use anyhow with .context()"
   - **Architecture Decisions** — Key architectural choices and their rationale (e.g., why Actor model, why specific crate choices)
4. Ensure the file ends with the CODA reference section (add if missing):

```markdown

## CODA Repository Documentation

See [.coda.md](.coda.md) for architecture overview and module guide. This file is auto-generated by CODA and kept up to date.
```

{% raw %}**If `CLAUDE.md` does not exist:**{% endraw %}

Generate a `CLAUDE.md` with the sections listed above, tailored to the detected tech stack. Target **60-80 lines**. Focus on project-SPECIFIC decisions that an AI agent cannot infer from the code itself. If a rule is standard practice for the detected language, do NOT include it.

The file must end with the CODA reference section shown above.
{% endif %}

## Verification

After completing all steps, verify:
{% if force %}- [ ] `.coda/config.yml` is valid YAML with user settings preserved
- [ ] `.coda.md` exists, is well-formatted, and includes Architecture Overview, Key Interfaces, and Data Flow sections
- [ ] `.coda.md` does NOT contain development workflow commands or coding conventions
- [ ] `.gitignore` contains `.trees/`
- [ ] `CLAUDE.md` contains Toolchain & Workflow, Project Conventions, and Architecture Decisions sections
- [ ] `CLAUDE.md` focuses on project-specific decisions (not generic language best practices)
- [ ] `CLAUDE.md` ends with the CODA reference section
{% else %}- [ ] `.coda/` directory exists
- [ ] `.trees/` directory exists
- [ ] `.coda/config.yml` is valid YAML
- [ ] `.gitignore` contains `.trees/`
- [ ] `.coda.md` exists, is well-formatted, and includes Architecture Overview, Key Interfaces, and Data Flow sections
- [ ] `.coda.md` does NOT contain development workflow commands or coding conventions
- [ ] `CLAUDE.md` contains Toolchain & Workflow, Project Conventions, and Architecture Decisions sections
- [ ] `CLAUDE.md` focuses on project-specific decisions (not generic language best practices)
- [ ] `CLAUDE.md` ends with the CODA reference section
{% endif %}
Report the result of each verification step.
