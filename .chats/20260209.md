# Instructions

## 初始化项目

这是一个Claude Orchestrated Development Agent（CODA）项目，它的主要功能是封装 claude agent sdk，让用户可以很方便的围绕一个 repo 来添加新的功能。请把这个 Rust项目转换成一个 workspace， 里面包含crates/coda-core(core execute engine)、crates/coda-pm(prompt manager),以及 apps/coda-cli(command line interface)。生成的是一个 coda cli。所有的 deps 放在 workspace 下， 各个crate 通过 `xx = { workspace = true }` 来引用。 CLI 使用 clap /ratatui 来构建。 p'r'o'mpt manager 使用 minijinja 来构建。 core execute engine 使用 tokio / claude-agent-sdk-rs 0.6 来构建。 所有 deps 都要使用最新版本。

## 生成设计文档

根据design.png，生成设计文档：

包括核心架构的 ascii diagram，以及重要的流程
各个 crate 有清晰的职责和 public interface
gba-core: 核心的执行引擎，根据不同场景下的 prompt，调用 claude agent sdk 来执行任务。务必提供非常精简可用的接口
gba-pm: 提示词管理器，负责加载、渲染、管理提示词。务必提供非常精简可用的接口
gba-cli: 命令行界面，负责与用户交互，并调用 gba-core 来执行任务。
代码结构尽可能职责单一，不要出现重复代码，follow SOLID principles，尽可能使用 Rust 的最新特性。
提供开发计划，包括每个阶段的任务。
设计文档放在 ./specs 下合适的位置

## optimize design

1. coda-core，应该设计Task、TaskResult、Session、Engine等类，Task包含不同类型，Init /Plan  / implement / test / review / verify 等。
2. 任务执行结果应该记录 turns / cost，放在 state.yml 中，最后的 PR link 也放进去。
3. 在 coda run 过程中，如果中断，下次运行可以继续恢复（在提示词里体现）。
4. 预先思考好所有场景下的提示词，放在 crates/coda-pm/templates 下，我来 review。提示词用英文

直接在crates/coda-pm/templates下生成所有的提示词模版

注意 init 的提示词应该还要生成 .coda / .trees 等目录，以及更改 .gitignore；run 的提示词最后要使用 gh cli 生成 pull request 并且提供详尽的 PR description.

## 1

请仔细review 提示词中的变量以及条件判断：

是否有必要 - 我们要尽可能 follow convention over configuration(约定优于配置)
是否能在 execution engine 的上下文提供

## 2

目前这些提示词哪些是作为 sys prompt 添加到 claude code 系统提示词中，哪些是作为 user prompt 来驱动完成工作？比如 gba init 的 user prompt 是什么？

## 3

请思考在不同的场景下，哪些需要 claude code preset，哪些不需要，哪些需要完整的工具，哪些不需要，这个应该在那里定义，是写在engine 中，还是配置中？

## 4

请参考claude-agent-sdk-rs的API重新给出方案，API如下：https://github.com/tyrchen/claude-agent-sdk-rs/blob/master/API.md

## 构建CODA

构建一个新的 git worktree (branch from main)，放在 .trees 下，仔细阅读 @specs/design.md，根据其要求，使用 sub agent 分阶段完成其功能。每次完成一个阶段后提交代码，并确保 precommit hooks 通过。完成所有阶段后，启动一个新的 sub agent 调用 rust-code-review skill 对照 design spec 来 review 代码，然后根据 review 结果仔细思考，对合理的问题进行修改，并提交代码。最后，保证所有的测试通过，并确保所有的功能都符合 design spec 的要求后，生成一个 pull request，提供详细的 PR description。
